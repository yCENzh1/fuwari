---
// æ¥æ”¶æ ‡é¢˜æ•°æ®
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;

// è·å–æ‰€æœ‰æ ‡é¢˜çº§åˆ« (h1-h6)
const filteredHeadings = headings.filter(heading => heading.depth >= 1 && heading.depth <= 6);
---

{filteredHeadings.length > 0 && (
  <div class="mb-5 rounded-[var(--radius-large)] overflow-hidden bg-black/5 dark:bg-white/5 backdrop-blur-sm">
    <!-- ç›®å½•æ ‡é¢˜æ  -->
    <button 
      class="toc-toggle w-full px-4 py-3 flex items-center justify-between text-sm font-medium text-black/70 dark:text-white/70 hover:bg-black/5 dark:hover:bg-white/5 transition-colors"
      type="button"
    >
      <span class="flex items-center gap-2">
        <div class="h-5 w-5 rounded-md bg-black/10 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center">
          ğŸ“‹
        </div>
        ç›®å½•
      </span>
      <span class="toc-arrow text-xs text-black/50 dark:text-white/50 transition-transform duration-300 ease-in-out">â–¼</span>
    </button>
    
    <!-- ç›®å½•å†…å®¹ -->
    <div class="toc-content max-h-0 overflow-y-auto px-4 border-t border-black/10 dark:border-white/10 transition-all duration-300 ease-in-out">
      <nav class="pt-3 pb-4">
        {filteredHeadings.map((heading) => {
          // æ ¹æ®æ ‡é¢˜çº§åˆ«è®¾ç½®ç¼©è¿›å’Œæ ·å¼
          const indentClass = heading.depth === 1 ? '' : 
                             heading.depth === 2 ? 'ml-2' :
                             heading.depth === 3 ? 'ml-4' :
                             heading.depth === 4 ? 'ml-6' :
                             heading.depth === 5 ? 'ml-8' : 'ml-10';
          
          const sizeClass = heading.depth === 1 ? 'text-sm font-bold' :
                           heading.depth === 2 ? 'text-sm font-medium' :
                           heading.depth === 3 ? 'text-xs font-medium' :
                           'text-xs';
          
          return (
            <a
              href={`#${heading.slug}`}
              class={`toc-link block py-2 text-black/60 dark:text-white/60 hover:text-[var(--primary)] transition-colors ${indentClass} ${sizeClass}`}
              data-heading-id={heading.slug}
            >
              {heading.text}
            </a>
          );
        })}
      </nav>
    </div>
  </div>
)}

<style>
  .toc-link.active {
    color: var(--primary);
    font-weight: 600;
  }
  
  /* å±•å¼€çŠ¶æ€çš„åŠ¨ç”» - å¢åŠ æœ€å¤§é«˜åº¦ä»¥æ”¯æŒæ›´å¤šæ ‡é¢˜ */
  .toc-content.expanded {
    max-height: 80vh; /* ä½¿ç”¨è§†å£é«˜åº¦ï¼Œæœ€å¤šå ç”¨80%çš„å±å¹•é«˜åº¦ */
  }
  
  /* ç®­å¤´æ—‹è½¬åŠ¨ç”» */
  .toc-arrow.rotated {
    transform: rotate(180deg);
  }
  
  /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ - ä½¿ç”¨æ›´æŸ”å’Œçš„é¢œè‰² */
  .toc-content::-webkit-scrollbar {
    width: 4px;
  }
  
  .toc-content::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .toc-content::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
  }
  
  .dark .toc-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
  }
  
  .toc-content::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.4);
  }
  
  .dark .toc-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.4);
  }
</style>

<script>
  // åˆå§‹åŒ–ç›®å½•åŠŸèƒ½
  function initTableOfContents() {
    const tocToggle = document.querySelector('.toc-toggle');
    const tocContent = document.querySelector('.toc-content');
    const tocArrow = document.querySelector('.toc-arrow');
    
    // é‡ç½®ç›®å½•çŠ¶æ€ä¸ºæ”¶èµ·
    if (tocContent && tocArrow) {
      tocContent.classList.remove('expanded');
      tocArrow.classList.remove('rotated');
    }
    
    // ç‚¹å‡»å±•å¼€/æ”¶èµ·åŠŸèƒ½
    if (tocToggle && tocContent && tocArrow) {
      // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      tocToggle.replaceWith(tocToggle.cloneNode(true));
      const newTocToggle = document.querySelector('.toc-toggle');
      const newTocArrow = document.querySelector('.toc-arrow');
      
      newTocToggle.addEventListener('click', () => {
        if (tocContent.classList.contains('expanded')) {
          // æ”¶èµ·
          tocContent.classList.remove('expanded');
          newTocArrow.classList.remove('rotated');
        } else {
          // å±•å¼€
          tocContent.classList.add('expanded');
          newTocArrow.classList.add('rotated');
        }
      });
    }
    
    // é«˜äº®å½“å‰é˜…è¯»ä½ç½®
    const observeHeadings = () => {
      const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
      const tocLinks = document.querySelectorAll('.toc-link');
      
      if (headings.length === 0 || tocLinks.length === 0) return;
      
      // æ¸…é™¤ä¹‹å‰çš„è§‚å¯Ÿå™¨
      if (window.tocObserver) {
        window.tocObserver.disconnect();
      }
      
      window.tocObserver = new IntersectionObserver((entries) => {
        let activeId = '';
        
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            activeId = entry.target.id;
          }
        });
        
        // æ›´æ–°é«˜äº®é“¾æ¥
        tocLinks.forEach(link => {
          const headingId = link.getAttribute('data-heading-id');
          if (headingId === activeId) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }, {
        rootMargin: '-20% 0px -80% 0px',
        threshold: 0
      });
      
      headings.forEach(heading => window.tocObserver.observe(heading));
    };
    
    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
    setTimeout(observeHeadings, 100);
  }
  
  // é¡µé¢é¦–æ¬¡åŠ è½½æ—¶åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', initTableOfContents);
  
  // ç›‘å¬é¡µé¢å†…å®¹å˜åŒ–ï¼ˆç”¨äºSPAè·¯ç”±åˆ‡æ¢ï¼‰
  document.addEventListener('astro:page-load', initTableOfContents);
  
  // å¤‡ç”¨æ–¹æ¡ˆï¼šç›‘å¬popstateäº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›åé€€ï¼‰
  window.addEventListener('popstate', () => {
    setTimeout(initTableOfContents, 100);
  });
  
  // å¹³æ»‘æ»šåŠ¨åŠŸèƒ½
  document.addEventListener('click', (e) => {
    const tocLink = e.target.closest('.toc-link');
    if (tocLink) {
      e.preventDefault();
      const targetId = tocLink.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // æ›´æ–° URL
        history.pushState(null, null, `#${targetId}`);
      }
    }
  });
</script>