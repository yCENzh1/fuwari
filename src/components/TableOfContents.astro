---
// æŽ¥æ”¶æ ‡é¢˜æ•°æ®
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;

// åªæ˜¾ç¤º h2 å’Œ h3 æ ‡é¢˜
const filteredHeadings = headings.filter(heading => heading.depth >= 2 && heading.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <div class="mb-5 card-base rounded-[var(--radius-large)] overflow-hidden">
    <!-- ç›®å½•æ ‡é¢˜æ  -->
    <button 
      class="toc-toggle w-full px-4 py-3 flex items-center justify-between text-sm font-medium text-black/70 dark:text-white/70 hover:bg-black/5 dark:hover:bg-white/5 transition-colors"
      type="button"
    >
      <span class="flex items-center gap-2">
        <div class="h-5 w-5 rounded-md bg-black/5 dark:bg-white/10 text-black/50 dark:text-white/50 flex items-center justify-center">
          ðŸ“‹
        </div>
        ç›®å½•
      </span>
      <span class="toc-arrow text-xs">â–¼</span>
    </button>
    
    <!-- ç›®å½•å†…å®¹ -->
    <div class="toc-content hidden px-4 pb-4 border-t border-[var(--line-divider)]">
      <nav class="pt-3">
        {filteredHeadings.map((heading) => (
          <a
            href={`#${heading.slug}`}
            class={`toc-link block py-2 text-sm text-black/60 dark:text-white/60 hover:text-[var(--primary)] transition-colors ${
              heading.depth === 2 ? 'font-medium' : 'ml-4 text-xs'
            }`}
            data-heading-id={heading.slug}
          >
            {heading.text}
          </a>
        ))}
      </nav>
    </div>
  </div>
)}

<style>
  .toc-link.active {
    color: var(--primary);
    font-weight: 500;
  }
</style>

<script>
  // ç‚¹å‡»å±•å¼€/æ”¶èµ·åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const tocToggle = document.querySelector('.toc-toggle');
    const tocContent = document.querySelector('.toc-content');
    const tocArrow = document.querySelector('.toc-arrow');
    
    if (tocToggle && tocContent && tocArrow) {
      tocToggle.addEventListener('click', () => {
        if (tocContent.classList.contains('hidden')) {
          // å±•å¼€
          tocContent.classList.remove('hidden');
          tocArrow.textContent = 'â–²';
        } else {
          // æ”¶èµ·
          tocContent.classList.add('hidden');
          tocArrow.textContent = 'â–¼';
        }
      });
    }
    
    // é«˜äº®å½“å‰é˜…è¯»ä½ç½®
    const observeHeadings = () => {
      const headings = document.querySelectorAll('h2[id], h3[id], h4[id], h5[id], h6[id]');
      const tocLinks = document.querySelectorAll('.toc-link');
      
      if (headings.length === 0 || tocLinks.length === 0) return;
      
      const observer = new IntersectionObserver((entries) => {
        let activeId = '';
        
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            activeId = entry.target.id;
          }
        });
        
        // æ›´æ–°é«˜äº®é“¾æŽ¥
        tocLinks.forEach(link => {
          const headingId = link.getAttribute('data-heading-id');
          if (headingId === activeId) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }, {
        rootMargin: '-20% 0px -80% 0px',
        threshold: 0
      });
      
      headings.forEach(heading => observer.observe(heading));
    };
    
    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
    setTimeout(observeHeadings, 100);
  });
  
  // å¹³æ»‘æ»šåŠ¨
  document.addEventListener('click', (e) => {
    const tocLink = e.target.closest('.toc-link');
    if (tocLink) {
      e.preventDefault();
      const targetId = tocLink.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // æ›´æ–° URL
        history.pushState(null, null, `#${targetId}`);
      }
    }
  });
</script>