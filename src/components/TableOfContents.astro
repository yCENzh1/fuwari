---
// æ¥æ”¶æ ‡é¢˜æ•°æ®
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings } = Astro.props;

// è·å–æ‰€æœ‰æ ‡é¢˜çº§åˆ« (h1-h6)
const filteredHeadings = headings.filter(heading => heading.depth >= 1 && heading.depth <= 6);
---

{filteredHeadings.length > 0 && (
  <div class="mb-5 rounded-[var(--radius-large)] overflow-hidden" style="background: var(--primary); background-opacity: 0.05;">
    <!-- ç›®å½•æ ‡é¢˜æ  -->
    <button 
      class="toc-toggle w-full px-4 py-3 flex items-center justify-between text-sm font-medium text-white/90 hover:bg-white/5 transition-colors"
      type="button"
    >
      <span class="flex items-center gap-2">
        <div class="h-5 w-5 rounded-md bg-white/15 text-white/70 flex items-center justify-center">
          ğŸ“‹
        </div>
        ç›®å½•
      </span>
      <span class="toc-arrow text-xs text-white/70 transition-transform duration-300 ease-in-out">â–¼</span>
    </button>
    
    <!-- ç›®å½•å†…å®¹ -->
    <div class="toc-content max-h-0 overflow-hidden px-4 border-t border-white/15 transition-all duration-300 ease-in-out">
      <nav class="pt-3 pb-4">
        {filteredHeadings.map((heading) => {
          // æ ¹æ®æ ‡é¢˜çº§åˆ«è®¾ç½®ç¼©è¿›å’Œæ ·å¼
          const indentClass = heading.depth === 1 ? '' : 
                             heading.depth === 2 ? 'ml-2' :
                             heading.depth === 3 ? 'ml-4' :
                             heading.depth === 4 ? 'ml-6' :
                             heading.depth === 5 ? 'ml-8' : 'ml-10';
          
          const sizeClass = heading.depth === 1 ? 'text-sm font-bold' :
                           heading.depth === 2 ? 'text-sm font-medium' :
                           heading.depth === 3 ? 'text-xs font-medium' :
                           'text-xs';
          
          return (
            <a
              href={`#${heading.slug}`}
              class={`toc-link block py-2 text-white/70 hover:text-white transition-colors ${indentClass} ${sizeClass}`}
              data-heading-id={heading.slug}
            >
              {heading.text}
            </a>
          );
        })}
      </nav>
    </div>
  </div>
)}

<style>
  .toc-link.active {
    color: white;
    font-weight: 600;
  }
  
  /* ä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºèƒŒæ™¯çš„åŠé€æ˜æ•ˆæœ */
  .mb-5 {
    background: rgba(var(--primary-rgb), 0.08);
    backdrop-filter: blur(8px);
  }
  
  /* å±•å¼€çŠ¶æ€çš„åŠ¨ç”» */
  .toc-content.expanded {
    max-height: 500px; /* æ ¹æ®éœ€è¦è°ƒæ•´æœ€å¤§é«˜åº¦ */
  }
  
  /* ç®­å¤´æ—‹è½¬åŠ¨ç”» */
  .toc-arrow.rotated {
    transform: rotate(180deg);
  }
</style>

<script>
  // ç‚¹å‡»å±•å¼€/æ”¶èµ·åŠŸèƒ½
  document.addEventListener('DOMContentLoaded', () => {
    const tocToggle = document.querySelector('.toc-toggle');
    const tocContent = document.querySelector('.toc-content');
    const tocArrow = document.querySelector('.toc-arrow');
    
    if (tocToggle && tocContent && tocArrow) {
      tocToggle.addEventListener('click', () => {
        if (tocContent.classList.contains('expanded')) {
          // æ”¶èµ·
          tocContent.classList.remove('expanded');
          tocArrow.classList.remove('rotated');
        } else {
          // å±•å¼€
          tocContent.classList.add('expanded');
          tocArrow.classList.add('rotated');
        }
      });
    }
    
    // é«˜äº®å½“å‰é˜…è¯»ä½ç½®
    const observeHeadings = () => {
      const headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
      const tocLinks = document.querySelectorAll('.toc-link');
      
      if (headings.length === 0 || tocLinks.length === 0) return;
      
      const observer = new IntersectionObserver((entries) => {
        let activeId = '';
        
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            activeId = entry.target.id;
          }
        });
        
        // æ›´æ–°é«˜äº®é“¾æ¥
        tocLinks.forEach(link => {
          const headingId = link.getAttribute('data-heading-id');
          if (headingId === activeId) {
            link.classList.add('active');
          } else {
            link.classList.remove('active');
          }
        });
      }, {
        rootMargin: '-20% 0px -80% 0px',
        threshold: 0
      });
      
      headings.forEach(heading => observer.observe(heading));
    };
    
    // å»¶è¿Ÿæ‰§è¡Œç¡®ä¿ DOM å®Œå…¨åŠ è½½
    setTimeout(observeHeadings, 100);
  });
  
  // å¹³æ»‘æ»šåŠ¨
  document.addEventListener('click', (e) => {
    const tocLink = e.target.closest('.toc-link');
    if (tocLink) {
      e.preventDefault();
      const targetId = tocLink.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // æ›´æ–° URL
        history.pushState(null, null, `#${targetId}`);
      }
    }
  });
</script>