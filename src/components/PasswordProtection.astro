/**
 * æ–‡ç« å¯†ç ä¿æŠ¤ç»„ä»¶
 * ä½¿ç”¨æ„å»ºæ—¶åŠ å¯†çš„å†…å®¹å’Œå¯†ç å“ˆå¸ŒéªŒè¯
 */
interface Props {
  slug: string;
  encryptedData?: {
    content: string;
    hash: string;
  };
  class?: string;
}

const { slug, encryptedData, class: className = '' } = Astro.props;
const formId = `password-form-${slug}`;
const contentId = `article-content-${slug}`;
const overlayId = `overlay-${slug}`;
---

<div id={overlayId} class={`password-protection-overlay ${className}`}>
  <div class="password-container card-base rounded-xl p-6 md:p-8 max-w-md w-full">
    <h3 class="font-bold text-xl mb-4 text-black/90 dark:text-white/90">ğŸ”’ æ­¤æ–‡ç« å·²åŠ å¯†</h3>
    <p class="mb-6 text-black/70 dark:text-white/70">æœ¬æ–‡ç« å†…å®¹å¯èƒ½å¿¤é€†éƒ¨åˆ†è¯»è€…æ‰€æŒçš„æ€æ½®ç«‹åœºã€å¹´é¾„èƒŒæ™¯æˆ–å…´è¶£åå¥½ã€‚è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œè‹¥æ‚¨ä¸æ¸…æ¥šå¯†ç ï¼Œè¯·è”ç³»åšä¸»è·å–ã€‚</p>
    <form id={formId} class="flex flex-col">
      <input 
        type="password" 
        class="form-input mb-4 p-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white/90 dark:bg-[#1a1a1a] text-black/90 dark:text-white/90 w-full focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" 
        placeholder="è¯·è¾“å…¥å¯†ç " 
        required
      />
      <button 
        type="submit" 
        class="bg-[var(--primary)] hover:bg-[var(--primary-dark)] rounded-md py-2 px-4 text-white font-medium transition-colors"
      >
        è§£é”å†…å®¹
      </button>
      <p id="error-message" class="text-red-500 mt-2 text-sm hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
    </form>
  </div>
</div>

<style>
.password-protection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--card-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 20;
  backdrop-filter: blur(5px);
}

.password-container {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.hidden-overlay {
  animation: fadeOut 0.3s forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; visibility: hidden; }
}

/* ç¡®ä¿åŠ å¯†å†…å®¹åœ¨é¡µé¢æºç ä¸­ä¸å¯è§ */
.encrypted-content {
  display: none !important;
}

.encrypted-content.unlocked {
  display: block !important;
}
</style>

<script define:vars={{ slug, encryptedData, formId, contentId, overlayId }} is:inline>
(function() {
  // åŠ¨æ€åŠ è½½æ‰€éœ€çš„åº“
  function loadLibraries() {
    return new Promise((resolve, reject) => {
      let loadedCount = 0;
      const totalLibs = 2;
      
      function checkComplete() {
        loadedCount++;
        if (loadedCount === totalLibs) {
          resolve();
        }
      }
      
      // åŠ è½½ crypto-js
      if (typeof CryptoJS === 'undefined') {
        const cryptoScript = document.createElement('script');
        cryptoScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js';
        cryptoScript.onload = checkComplete;
        cryptoScript.onerror = () => reject(new Error('Failed to load crypto-js'));
        document.head.appendChild(cryptoScript);
      } else {
        checkComplete();
      }
      
      // åŠ è½½ bcryptjs
      if (typeof dcodeIO === 'undefined') {
        const bcryptScript = document.createElement('script');
        bcryptScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js';
        bcryptScript.onload = checkComplete;
        bcryptScript.onerror = () => reject(new Error('Failed to load bcryptjs'));
        document.head.appendChild(bcryptScript);
      } else {
        checkComplete();
      }
    });
  }
  
  function initEncryption() {
    // æ£€æŸ¥æ˜¯å¦å·²è§£é”
    const storageKey = `fuwari-unlocked-${slug}`;
    const isUnlocked = localStorage.getItem(storageKey) === 'true';
    
    if (isUnlocked) {
      // å¦‚æœå·²è§£é”ï¼Œå°è¯•ä»ç¼“å­˜è·å–å†…å®¹
      const cachedContent = localStorage.getItem(`fuwari-content-${slug}`);
      if (cachedContent) {
        const contentElement = document.getElementById(contentId);
        if (contentElement) {
          renderMarkdownContent(cachedContent, contentElement);
          document.getElementById(overlayId).classList.add('hidden-overlay');
        }
      }
    }
    
    // è¡¨å•æäº¤å¤„ç†
    const form = document.getElementById(formId);
    if (form && encryptedData) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const inputPassword = e.target.querySelector('input[type="password"]').value;
        const errorElement = document.getElementById('error-message');
        const submitButton = e.target.querySelector('button[type="submit"]');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const originalText = submitButton.textContent;
        submitButton.textContent = 'éªŒè¯ä¸­...';
        submitButton.disabled = true;
        
        try {
          // ä½¿ç”¨bcryptéªŒè¯å¯†ç å“ˆå¸Œ
          const isValidPassword = dcodeIO.bcrypt.compareSync(inputPassword, encryptedData.hash);
          
          if (isValidPassword) {
            // å¯†ç æ­£ç¡®ï¼Œè§£å¯†å†…å®¹
            const decryptedBytes = CryptoJS.AES.decrypt(encryptedData.content, inputPassword);
            const decryptedMarkdown = decryptedBytes.toString(CryptoJS.enc.Utf8);
            
            if (decryptedMarkdown) {
              // è§£å¯†æˆåŠŸï¼Œæ¸²æŸ“Markdownå†…å®¹
              localStorage.setItem(storageKey, 'true');
              localStorage.setItem(`fuwari-content-${slug}`, decryptedMarkdown);
              
              const contentElement = document.getElementById(contentId);
              if (contentElement) {
                renderMarkdownContent(decryptedMarkdown, contentElement);
                document.getElementById(overlayId).classList.add('hidden-overlay');
              }
              
              errorElement.classList.add('hidden');
            } else {
              throw new Error('è§£å¯†å¤±è´¥');
            }
          } else {
            // å¯†ç é”™è¯¯
            errorElement.classList.remove('hidden');
            e.target.querySelector('input[type="password"]').value = '';
          }
        } catch (error) {
          console.error('éªŒè¯å¤±è´¥:', error);
          errorElement.classList.remove('hidden');
          e.target.querySelector('input[type="password"]').value = '';
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      });
    }
  }

  // æ¸²æŸ“Markdownå†…å®¹ä¸ºHTML
  function renderMarkdownContent(markdown, targetElement) {
    // åŠ¨æ€åŠ è½½markedåº“æ¥è§£æMarkdown
    if (typeof marked === 'undefined') {
      const markedScript = document.createElement('script');
      markedScript.src = 'https://cdn.jsdelivr.net/npm/marked@12.0.0/lib/marked.umd.js';
      markedScript.onload = function() {
        const html = marked.parse(markdown);
        targetElement.innerHTML = `<div class="w-full !max-w-none custom-md dark:prose-invert prose prose-base" data-pagefind-body>${html}</div>`;
        targetElement.classList.remove('hidden');
        targetElement.classList.add('unlocked');
      };
      document.head.appendChild(markedScript);
    } else {
      const html = marked.parse(markdown);
      targetElement.innerHTML = `<div class="w-full !max-w-none custom-md dark:prose-invert prose prose-base" data-pagefind-body>${html}</div>`;
      targetElement.classList.remove('hidden');
      targetElement.classList.add('unlocked');
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      loadLibraries().then(initEncryption).catch(console.error);
    });
  } else {
    loadLibraries().then(initEncryption).catch(console.error);
  }
})();
</script>
