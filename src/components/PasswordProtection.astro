---
/**
 * æ–‡ç« å¯†ç ä¿æŠ¤ç»„ä»¶
 * ä½¿ç”¨æ„å»ºæ—¶åŠ å¯†çš„å†…å®¹å’Œå¯†ç å“ˆå¸ŒéªŒè¯
 */
interface Props {
  slug: string;
  encryptedData?: {
    content: string;
    hash: string;
  };
  class?: string;
}

const { slug, encryptedData, class: className = '' } = Astro.props;
const formId = `password-form-${slug}`;
const contentId = `article-content-${slug}`;
const overlayId = `overlay-${slug}`;
---

<div id={overlayId} class={`password-protection-overlay ${className}`} data-slug={slug}>
  <div class="password-container card-base rounded-xl p-6 md:p-8 max-w-md w-full">
    <h3 class="font-bold text-xl mb-4 text-black/90 dark:text-white/90">ğŸ”’ æ­¤æ–‡ç« å·²åŠ å¯†</h3>
    <p class="mb-6 text-black/70 dark:text-white/70">æœ¬æ–‡ç« å†…å®¹å¯èƒ½å¿¤é€†éƒ¨åˆ†è¯»è€…æ‰€æŒçš„æ€æ½®ç«‹åœºã€å¹´é¾„èƒŒæ™¯æˆ–å…´è¶£åå¥½ã€‚è¯·è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œè‹¥æ‚¨ä¸æ¸…æ¥šå¯†ç ï¼Œè¯·è”ç³»åšä¸»è·å–ã€‚</p>
    <form id={formId} class="flex flex-col">
      <input 
        type="password" 
        class="form-input mb-4 p-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white/90 dark:bg-[#1a1a1a] text-black/90 dark:text-white/90 w-full focus:outline-none focus:ring-2 focus:ring-[var(--primary)]" 
        placeholder="è¯·è¾“å…¥å¯†ç " 
        required
      />
      <button 
        type="submit" 
        class="bg-[var(--primary)] hover:bg-[var(--primary-dark)] rounded-md py-2 px-4 text-white font-medium transition-colors"
      >
        è§£é”å†…å®¹
      </button>
      <p id="error-message" class="text-red-500 mt-2 text-sm hidden">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</p>
    </form>
  </div>
</div>

<!-- å°†åŠ å¯†æ•°æ®å­˜å‚¨åœ¨éšè—å…ƒç´ ä¸­ -->
{encryptedData && (
  <div 
    id={`encrypted-data-${slug}`} 
    style="display: none;" 
    data-content={encryptedData.content}
    data-hash={encryptedData.hash}
  ></div>
)}

<style>
.password-protection-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--card-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 20;
  backdrop-filter: blur(5px);
}

.password-container {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.hidden-overlay {
  animation: fadeOut 0.3s forwards;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; visibility: hidden; }
}

.encrypted-content {
  display: none !important;
}

.encrypted-content.unlocked {
  display: block !important;
}
</style>

<script>
// å°†è„šæœ¬ç§»åˆ°å•ç‹¬çš„æ–‡ä»¶æˆ–ä½¿ç”¨ä¸åŒçš„æ–¹å¼å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
  const overlays = document.querySelectorAll('.password-protection-overlay');
  
  overlays.forEach(overlay => {
    const slug = overlay.dataset.slug;
    const formId = `password-form-${slug}`;
    const contentId = `article-content-${slug}`;
    const overlayId = `overlay-${slug}`;
    const encryptedDataEl = document.getElementById(`encrypted-data-${slug}`);
    
    if (!encryptedDataEl) return;
    
    const encryptedData = {
      content: encryptedDataEl.dataset.content,
      hash: encryptedDataEl.dataset.hash
    };
    
    // åˆå§‹åŒ–å¯†ç ä¿æŠ¤é€»è¾‘
    initPasswordProtection(slug, formId, contentId, overlayId, encryptedData);
  });
});

function initPasswordProtection(slug, formId, contentId, overlayId, encryptedData) {
  // è¿™é‡Œæ”¾ç½®åŸæ¥çš„åˆå§‹åŒ–é€»è¾‘
  // ä½†æ˜¯è¦ç¡®ä¿åº“å·²ç»åŠ è½½
}
</script>